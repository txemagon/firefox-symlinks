#!/usr/bin/python

import sys
import os.path
from testrunhelper import TestRunHelper

class XPCShellTestsHelper(TestRunHelper):
  def __init__(self):
    PASSTHROUGH_ARGS = [
      '--interactive',
      '--verbose',
      '--manifest',
      '--debugger',
      '--debugger-args',
      '--debugger-interactive',
      '--testing-modules-dir',
      '--tests-root-dir',
      '--xunit-file',
      '--xunit-suite-name'
    ]

    root = '/@MOZ_TESTDIR@'
    args = iter(sys.argv[1:])
    while True:
      try:
        arg = args.next()
      except StopIteration:
        break

      if arg == '--harness-root-dir':
        try:
          root = args.next()
          break
        except StopIteration:
          pass

    TestRunHelper.__init__(self, 'xpcshell/runxpcshelltests.py',
                           lambda g: g['XPCShellOptions'](),
                           pass_args=PASSTHROUGH_ARGS,
                           paths=[], root=root,
                           need_x=True, need_dbus=True)

    self.add_option('--harness-root-dir',
                    dest='root',
                    help='Override the path to the test harness installation')
    self.add_option('--xpcshell',
                    dest='xpcshell', default=None,
                    help='Override the path to the xpcshell binary')
    self.add_option('--logfiles',
                    action='store_true', dest='logfiles', default=False,
                    help='Create log files')

def main():
  abspath = lambda x: os.path.join(helper.root, x)

  DEFAULTS = {
    '--build-info-json': lambda: abspath('python/mozinfo.json') if os.path.exists(abspath('python/mozinfo.json')) else abspath('xpcshell/mozinfo.json'),
    '--test-plugin-path': lambda: abspath('plugins')
  }

  def pre_run_cb(options, args):
    if not options.logfiles:
      sys.argv.append('--no-logfiles')

    if '--xunit-file' in sys.argv and '--tests-root-dir' not in sys.argv and \
       '--manifest' in sys.argv:
        sys.argv.extend(['--tests-root-dir', os.path.dirname(options.manifest)])

    for arg in args:
      if arg.endswith('.js'):
        if len(args) > 1:
          raise Exception('Can only specify one file at a time')
        sys.argv.extend(['--test-path', os.path.basename(arg)])
        args[0] = os.path.dirname(arg)

    sys.argv.append(os.path.join(helper.root, 'bin', 'xpcshell') if options.xpcshell == None else options.xpcshell)

  helper = XPCShellTestsHelper()
  sys.exit(helper.run(defaults=DEFAULTS, pre_run_cb=pre_run_cb))

if __name__ == '__main__':
  main()
